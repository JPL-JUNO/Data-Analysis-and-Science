\chapter{\label{ch11}}
\section{基本思想}
要使该应用程序可添加书签，我们需要做三件事：
\begin{itemize}
    \item 添加 bookmarkButton() 到 UI。这会生成一个按钮，用户单击该按钮即可生成可添加书签的 URL。
    \item 转变ui成一个函数。您需要这样做，因为添加书签的应用程序必须重播添加书签的值：实际上，Shiny 修改了value每个输入控件的默认值。这意味着不再是单个静态 UI，而是依赖于 URL 中参数的多个可能的 UI；即它必须是一个函数。
    \item 添加 enableBookmarking = "url" 到shinyApp()通话中。
\end{itemize}
\subsection{更新 URL}
另一种选择是自动更新浏览器中的 URL，而不是提供显式按钮。这允许您的用户在浏览器中使用用户书签命令，或从地址栏中复制并粘贴 URL。

自动更新 URL 需要服务器函数中的一些样板。
\subsection{存储更丰富的状态}
到目前为止，我们已经使用了 enableBookmarking = "url" 直接将状态存储在 URL 中的方法。这是一个很好的起点，因为它非常简单并且适用于您可能部署 Shiny 应用程序的任何地方。然而，正如您可以想象的那样，如果您有大量输入，URL 将会变得很长，并且显然无法捕获上传的文件。

对于这些情况，您可能需要使用 enableBookmarking = "server"，它将状态保存到 .rds 服务器上的文件中。这总是会生成一个短的、不透明的 URL，但需要在服务器上进行额外的存储。

服务器书签的主要缺点是它需要将文件保存在服务器上，并且这些文件需要保留多长时间并不明显。如果您为复杂状态添加书签并且从不删除这些文件，那么随着时间的推移，您的应用程序将占用越来越多的磁盘空间。如果您删除了这些文件，一些旧书签将停止工作。

\section{书签挑战}
自动书签依赖于反应图。它使用保存的值播种输入，然后重播所有反应式表达式和输出，只要您的应用程序的反应图很简单，这就会生成与您看到的相同的应用程序。本节简要介绍了一些需要额外注意的情况：

如果您的应用使用随机数，即使所有输入都相同，结果也可能不同。如果始终生成相同的数字确实很重要，那么您需要考虑如何使随机过程可重现。最简单的方法是使用 repeatable();

如果您有选项卡并且想要添加书签并恢复活动选项卡，请确保在您的调用中为 tabsetPanel() 提供 id；

如果存在不应添加书签的输入，例如它们包含不应共享的私人信息，请在服务器功能中某处包括对 setBookmarkExclude() 的调用。例如，setBookmarkExclude(c("secret1", "secret2")) 将确保 secret1 和 secret2 输入未添加书签。

如果您在自己的 reactiveValues() 对象中手动管理反应状态（正如我们将在\nameref{ch16}中讨论的那样），您将需要使用 onBookmark() 和 onRestore() 回调来手动保存和加载附加状态。有关详细信息，请参阅\href{https://shiny.posit.co/r/articles/share/advanced-bookmarking/}{高级书签}。